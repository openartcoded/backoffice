<ng-container *ngIf="post">
  <div class="container overflow-y-scroll py-3">
    <a routerLink="/report" class="btn btn-outline-primary mb-3">
      <fa-icon [icon]="['fas', 'arrow-left']" class="me-1"></fa-icon>
      Back
    </a>

    <div class="text-center mb-3">
      <app-image-loader [image]="cover" *ngIf="cover" cssClass="border shadow-sm cover rounded-0" alt="Cover image" />
      <img
        class="border shadow-sm cover rounded-0"
        *ngIf="!cover"
        src="/assets/img/no-cover.png"
        alt="No cover available"
      />
    </div>

    <article class="mt-3">
      <ul ngbNav #nav="ngbNav" class="nav-tabs">
        <li ngbNavItem>
          <a ngbNavLink>Metadata</a>
          <ng-template ngbNavContent>
            <div class="card flat shadow-sm mb-3" style="height: 58vh; overflow-y: scroll">
              <div
                class="card-header bg-light rounded-0 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center"
              >
                <h4 class="mb-2 mb-md-0">
                  <span class="me-1" *ngIf="post.priority === 'LOW'">üîµ</span>
                  <span class="me-1" *ngIf="post.priority === 'MEDIUM'">üü°</span>
                  <span class="me-1" *ngIf="post.priority === 'HIGH'">üü†</span>
                  <span class="me-1" *ngIf="post.priority === 'URGENT'">üî¥</span>
                  <span class="me-1" *ngIf="post.status === 'DRAFT'">üìù</span>
                  <span class="me-1" *ngIf="post.status === 'IN_PROGRESS'">‚è≥</span>
                  <span class="me-1" *ngIf="post.status === 'PENDING'">üïó</span>
                  <span class="me-1" *ngIf="post.status === 'DONE'">‚úÖ</span>
                  <span class="me-1" *ngIf="post.status === 'CANCELLED'">‚ùå</span>

                  {{ post.title | titlecase }}
                </h4>
                <div>
                  <button (click)="$event.preventDefault(); generatePdf()" class="btn btn-link">
                    <fa-icon [icon]="['fas', 'file-pdf']" class="text-muted me-1"></fa-icon>
                  </button>
                  <small class="text-muted">Last updated: {{ post.updatedDate | date: 'dd/MM/yyyy HH:mm' }}</small>
                </div>
              </div>
              <div class="card-body text-ws-break">
                {{ post.description }}
              </div>
              <div class="card-footer bg-transparent">
                <span class="badge bg-success flat text-light me-1 mb-1 fs-6" *ngFor="let t of post.tags"
                  >#{{ t }}</span
                >
              </div>
            </div>
          </ng-template>
        </li>
        <li ngbNavItem *ngIf="post.content?.length">
          <a ngbNavLink>Content</a>
          <ng-template ngbNavContent>
            <div class="border rounded-0 shadow-sm p-3 mb-3" style="height: 58vh; overflow-y: scroll">
              <markdown [data]="post.content"></markdown>
            </div>
          </ng-template>
        </li>
        <li ngbNavItem *ngIf="post.attachments?.length">
          <a ngbNavLink>Attachments</a>

          <ng-template ngbNavContent>
            <div style="height: 58vh; overflow-y: scroll">
              <div class="d-flex justify-content-between align-items-center mt-2 mb-2">
                <label class="fw-bold d-block">Attachments</label>

                <button
                  [disabled]="!post.attachments?.length"
                  class="btn btn-warning"
                  (click)="$event.preventDefault(); downloadBulk(post.attachments)"
                >
                  Download all
                </button>
              </div>
              <ul class="list-group mb-3 rounded-0">
                <li
                  *ngFor="let a of post.attachments"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div class="mb-2 mb-md-0">
                    <ng-template #previewThumb>
                      <app-image-loader
                        cssClass="m-0 p-0 img-fluid rounded"
                        *ngIf="a.transientThumbnail"
                        [image]="a.transientThumbnail"
                      />
                    </ng-template>
                    <div class="p-0">
                      <button
                        type="button"
                        class="btn btn-link p-0 m-0 text-dark text-decoration-none"
                        [ngbTooltip]="previewThumb"
                        #btn="ngbTooltip"
                        (touchstart)="btn.open()"
                        (touchend)="btn.close()"
                        tooltipClass="m-0 p-0 opacity-100 bg-transparent border flat shadow-sm"
                      >
                        <fa-icon class="p-0 m-0" [icon]="['fas', 'info-circle']"></fa-icon>
                      </button>

                      <a class="btn btn-link p-0 text-decoration-none ms-1 text-break" (click)="download(a)">
                        <abbr [title]="a.originalFilename">
                          {{ a.originalFilename | trim: 30 }}
                        </abbr>
                      </a>
                    </div>
                  </div>
                  <div>
                    <fa-icon
                      *ngIf="isProcessed(a)"
                      [icon]="['fas', 'check-circle']"
                      class="me-1 text-success"
                    ></fa-icon>
                    <fa-icon *ngIf="!isProcessed(a)" [icon]="['fas', 'check-circle']" class="me-1 text-muted"></fa-icon>
                    <div ngbDropdown class="btn-group">
                      <button
                        class="btn btn-link dropdown-toggle text-secondary"
                        ngbDropdownToggle
                        type="button"
                        aria-expanded="false"
                      >
                        <fa-icon [icon]="['fas', 'ellipsis-v']"></fa-icon>
                      </button>
                      <div ngbDropdownMenu class="shadow-sm border-0 p-1">
                        <button ngbDropdownItem *ngIf="isPdf(a)" (click)="$event.preventDefault(); openPdfViewer(a)">
                          <fa-icon [icon]="['fas', 'file-pdf']" class="text-secondary me-1"></fa-icon>
                          View PDF
                        </button>
                        <button ngbDropdownItem *ngIf="isXML(a)" (click)="$event.preventDefault(); openPdfViewer(a)">
                          <fa-icon [icon]="['fas', 'file-code']" class="text-secondary me-1"></fa-icon>
                          View XML
                        </button>
                        <button
                          ngbDropdownItem
                          *ngIf="isImage(a)"
                          (click)="$event.preventDefault(); openImageViewer(a)"
                        >
                          <fa-icon [icon]="['fas', 'file-image']" class="text-secondary me-1"></fa-icon>
                          View Image
                        </button>
                        <button ngbDropdownItem (click)="$event.preventDefault(); download(a)">
                          <fa-icon [icon]="['fas', 'download']" class="text-secondary me-1"></fa-icon>
                          Download
                        </button>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </ng-template>
        </li>
        <li ngbNavItem *ngIf="user && channel">
          <a ngbNavLink
            >Channel
            <span
              class="badge rounded-4 align-items-center"
              [class.text-muted]="unReadMessagesCount === 0"
              [class.bg-light]="unReadMessagesCount === 0"
              [class.bg-danger]="unReadMessagesCount > 0"
              >{{ unReadMessagesCount }}</span
            ></a
          >
          <ng-template ngbNavContent>
            <app-channel (onChannelRefreshed)="updateChannel($event)" [user]="user" [post]="post" />
          </ng-template>
        </li>
        <li ngbNavItem>
          <a ngbNavLink>Tasks</a>
          <ng-template ngbNavContent>
            <div class="hidden-scroll">
              <app-scrum-board *ngIf="post" [post]="post" height="57vh" />
            </div>
          </ng-template>
        </li>
      </ul>
      <div class="p-0 mt-1" [ngbNavOutlet]="nav"></div>
    </article>
  </div>
</ng-container>
